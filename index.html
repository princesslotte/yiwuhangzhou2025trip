<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>義烏杭州之旅 / 이우항주여행</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 字體設定 */
        .font-zh { font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif; }
        .font-kr { font-family: 'SeoulNamsan', 'SeoulHangang', 'Noto Sans KR', sans-serif; }

        :root {
            --theme-text: #594a40;
            --theme-bg: #f8e8c1;
            --dot-color: #deaa6e;
        }

        body {
            background-color: var(--theme-bg);
            /* 波點背景：增加間距以降低 30% 密度 (原約 20px -> 改為 35px) */
            background-image: radial-gradient(var(--dot-color) 15%, transparent 15%),
                              radial-gradient(var(--dot-color) 15%, transparent 15%);
            background-position: 0 0, 17.5px 17.5px;
            background-size: 35px 35px; 
            background-attachment: fixed;
            color: var(--theme-text);
            -webkit-tap-highlight-color: transparent;
        }

        /* 毛玻璃效果 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(89, 74, 64, 0.05);
        }

        /* 擬真機票樣式 */
        .ticket-card {
            background: white;
            position: relative;
            /* 使用 clip-path 製作兩側缺口 */
            clip-path: polygon(
                0% 0%, 100% 0%, 
                100% calc(50% - 8px), 96% 50%, 100% calc(50% + 8px), 
                100% 100%, 0% 100%, 
                0% calc(50% + 8px), 4% 50%, 0% calc(50% - 8px)
            );
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .ticket-dashed-line {
            border-top: 2px dashed #deaa6e;
            position: relative;
            margin: 10px 0;
            opacity: 0.5;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Modal 動畫 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    </style>
</head>
<body class="min-h-screen pb-24">

<div id="app" class="max-w-[480px] mx-auto min-h-screen relative" :class="currentLang === 'zh' ? 'font-zh' : 'font-kr'">
    
    <!-- 頂部整合卡片 (Header + Weather + Location + Lang) -->
    <header class="sticky top-4 z-30 mx-4 mb-4 rounded-3xl glass-panel p-4 transition-all duration-300">
        <div class="flex justify-between items-start">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold tracking-tight">{{ t('title') }}</h1>
                <div class="flex items-center gap-3 mt-1 text-xs font-bold opacity-80">
                    <span class="flex items-center gap-1 bg-[#deaa6e]/20 px-2 py-1 rounded-lg">
                        <i class="fa-solid fa-location-dot text-[#deaa6e]"></i> {{ currentLocationName }}
                    </span>
                    <span v-if="weather" class="flex items-center gap-1 bg-[#deaa6e]/20 px-2 py-1 rounded-lg">
                        <i class="fa-solid fa-cloud text-[#deaa6e]"></i> {{ weather.temperature }}°C
                    </span>
                    <span v-else class="text-[10px] opacity-60">Loading...</span>
                </div>
            </div>
            
            <button @click="toggleLang" 
                class="bg-[#594a40] text-[#f8e8c1] px-3 py-1.5 rounded-full text-xs font-bold shadow-sm active:scale-95 transition-transform hover:bg-[#4a3b32]">
                {{ currentLang === 'zh' ? '한국어' : '繁體中文' }}
            </button>
        </div>
    </header>

    <!-- 日期導航 (適應手機寬度) -->
    <div class="mx-4 mb-4">
        <div class="glass-panel rounded-2xl p-1 flex justify-between gap-1 overflow-x-auto">
            <button v-for="(date, index) in scheduleDates" :key="index"
                @click="selectedDate = date"
                class="flex-1 py-2 rounded-xl text-center transition-all duration-200 min-w-[50px]"
                :class="selectedDate === date ? 'bg-[#594a40] text-[#f8e8c1] shadow-md' : 'hover:bg-[#deaa6e]/10 text-[#594a40]'">
                <div class="text-[9px] opacity-70 uppercase tracking-widest font-bold">Day {{ index + 1 }}</div>
                <div class="text-xs font-bold mt-0.5">{{ formatDate(date) }}</div>
            </button>
        </div>
    </div>

    <!-- 主要內容區 -->
    <main class="px-4 space-y-4">

        <!-- 航班資訊 (僅在 12/30 和 1/4 顯示) -->
        <div v-if="isFlightDate" class="space-y-3 animate-fade-in">
            <div class="flex items-center gap-2 mb-1 px-1 opacity-70">
                <i class="fa-solid fa-plane-departure text-xs"></i>
                <span class="text-xs font-bold">{{ t('flightInfo') }}</span>
            </div>

            <div v-for="(flight, idx) in currentFlights" :key="idx" class="drop-shadow-sm">
                <div class="ticket-card rounded-xl p-4 text-[#594a40]">
                    <!-- 上半部：航班號與日期 -->
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-plane text-[#deaa6e]"></i>
                            <span class="font-bold text-lg">{{ flight.code }}</span>
                        </div>
                        <div class="text-[10px] font-bold border border-[#594a40] px-1.5 py-0.5 rounded opacity-60">
                            {{ formatDateFull(selectedDate) }}
                        </div>
                    </div>
                    
                    <!-- 下半部：航線時間 -->
                    <div class="flex justify-between items-center text-center mt-3">
                        <div class="text-left w-1/3">
                            <div class="text-xl font-bold leading-none">{{ flight.depTime }}</div>
                            <div class="text-xs font-bold mt-1">{{ flight.depAirport }} <span class="bg-[#594a40] text-[#f8e8c1] px-1 rounded text-[10px]">{{ flight.depTerminal }}</span></div>
                        </div>
                        
                        <div class="flex-1 px-2 flex flex-col items-center opacity-50">
                            <i class="fa-solid fa-plane-engines text-xs mb-1"></i>
                            <div class="w-full h-[1px] bg-[#594a40] border-t border-dashed border-[#594a40]"></div>
                        </div>

                        <div class="text-right w-1/3">
                            <div class="text-xl font-bold leading-none">{{ flight.arrTime }}</div>
                            <div class="text-xs font-bold mt-1">{{ flight.arrAirport }} <span class="bg-[#594a40] text-[#f8e8c1] px-1 rounded text-[10px]">{{ flight.arrTerminal }}</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 行程列表 -->
        <div class="glass-panel p-5 rounded-3xl min-h-[400px]">
            <div class="flex justify-between items-center mb-5">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-list-check text-[#deaa6e]"></i> {{ t('schedule') }}
                </h3>
                <button @click="addItem" class="w-8 h-8 rounded-full bg-[#594a40] text-[#f8e8c1] flex items-center justify-center shadow hover:bg-opacity-90 active:scale-90 transition">
                    <i class="fa-solid fa-plus text-sm"></i>
                </button>
            </div>

            <div v-if="currentItinerary.length === 0" class="text-center py-12 opacity-40 flex flex-col items-center">
                <i class="fa-regular fa-calendar-plus text-4xl mb-3"></i>
                <p class="text-sm font-bold">{{ t('noSchedule') }}</p>
            </div>

            <!-- 時間軸樣式 -->
            <div class="relative pl-4 space-y-6 border-l-2 border-[#deaa6e]/30 ml-2">
                <div v-for="(item, index) in currentItinerary" :key="item.id" class="relative group">
                    <!-- 圓點 -->
                    <div class="absolute -left-[23px] top-1.5 w-3.5 h-3.5 rounded-full bg-[#deaa6e] border-2 border-[#f8e8c1] shadow-sm"></div>
                    
                    <!-- 卡片內容 -->
                    <div class="bg-white/80 p-3 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                        <div v-if="!item.isEditing" class="flex justify-between items-start gap-2">
                            <div class="flex-1">
                                <div class="font-bold text-[#deaa6e] text-xs mb-1 bg-[#594a40]/5 inline-block px-1.5 rounded">{{ item.time }}</div>
                                <div class="font-medium whitespace-pre-wrap leading-relaxed text-sm">{{ item.content }}</div>
                            </div>
                            <!-- 操作按鈕 (Desktop hover / Mobile always visible slight opacity) -->
                            <div class="flex flex-col gap-2 ml-1">
                                <button @click="editItem(index)" class="text-[#594a40]/40 hover:text-[#594a40] p-1"><i class="fa-solid fa-pen"></i></button>
                                <button @click="deleteItem(index)" class="text-red-400/60 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>

                        <!-- 編輯模式 -->
                        <div v-else class="space-y-2">
                            <input v-model="item.editTime" type="time" class="w-full p-2 rounded-lg bg-[#f8e8c1]/30 border border-[#deaa6e]/50 text-sm font-bold text-[#594a40]">
                            <textarea v-model="item.editContent" rows="2" class="w-full p-2 rounded-lg bg-[#f8e8c1]/30 border border-[#deaa6e]/50 text-sm"></textarea>
                            <div class="flex gap-2 justify-end pt-1">
                                <button @click="saveItem(index)" class="px-3 py-1 bg-[#594a40] text-[#f8e8c1] text-xs rounded-full font-bold">OK</button>
                                <button @click="cancelEdit(index)" class="px-3 py-1 bg-gray-300 text-gray-600 text-xs rounded-full font-bold">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部導航選單 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-[#594a40] text-[#f8e8c1] pb-safe z-40 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.15)]">
        <div class="max-w-[480px] mx-auto flex justify-around items-center h-16">
            <button @click="openModal('hotel')" class="flex flex-col items-center justify-center w-1/4 h-full active:bg-white/10 transition rounded-tl-2xl">
                <i class="fa-solid fa-hotel text-lg mb-1"></i>
                <span class="text-[10px] font-bold">{{ t('menu.hotel') }}</span>
            </button>
            <button @click="openModal('prep')" class="flex flex-col items-center justify-center w-1/4 h-full active:bg-white/10 transition">
                <i class="fa-solid fa-suitcase-rolling text-lg mb-1"></i>
                <span class="text-[10px] font-bold">{{ t('menu.prep') }}</span>
            </button>
            <button @click="openModal('info')" class="flex flex-col items-center justify-center w-1/4 h-full active:bg-white/10 transition">
                <i class="fa-solid fa-map-location-dot text-lg mb-1"></i>
                <span class="text-[10px] font-bold">{{ t('menu.info') }}</span>
            </button>
            <button @click="openModal('rate')" class="flex flex-col items-center justify-center w-1/4 h-full active:bg-white/10 transition rounded-tr-2xl">
                <i class="fa-solid fa-calculator text-lg mb-1"></i>
                <span class="text-[10px] font-bold">{{ t('menu.rate') }}</span>
            </button>
        </div>
    </nav>

    <!-- 彈出式視窗 (Modals) -->
    <transition name="fade">
        <div v-if="activeModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            <!-- 背景遮罩 -->
            <div class="absolute inset-0 bg-[#594a40]/60 backdrop-blur-sm pointer-events-auto" @click="closeModal"></div>
            
            <!-- 視窗內容 -->
            <transition name="slide-up" appear>
                <div class="bg-[#f8e8c1] w-full max-w-[480px] h-[85vh] sm:h-[75vh] sm:rounded-2xl rounded-t-3xl shadow-2xl overflow-hidden pointer-events-auto flex flex-col relative">
                    
                    <!-- 標題列 -->
                    <div class="p-4 border-b border-[#594a40]/10 flex justify-between items-center bg-[#f8e8c1] shrink-0">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <i class="fa-solid fa-circle text-[#deaa6e] text-[8px]"></i>
                            {{ t('menu.' + activeModal) }}
                        </h2>
                        <button @click="closeModal" class="w-8 h-8 rounded-full bg-[#594a40]/10 hover:bg-[#594a40]/20 flex items-center justify-center transition text-[#594a40]">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <!-- 滾動內容區 -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-12">
                        
                        <!-- 酒店資訊 -->
                        <div v-if="activeModal === 'hotel'" class="space-y-4">
                            <div v-for="h in hotels[currentLang]" :key="h.name" class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-[#deaa6e]">
                                <div class="text-xs font-bold text-[#deaa6e] mb-1 uppercase tracking-wide flex items-center gap-1">
                                    <i class="fa-solid fa-map-pin"></i> {{ h.city }}
                                </div>
                                <h3 class="font-bold text-lg mb-2 leading-tight">{{ h.name }}</h3>
                                <p class="text-sm opacity-70 mb-4 bg-gray-50 p-2 rounded">{{ h.address }}</p>
                                <a :href="h.url" target="_blank" class="flex items-center justify-center gap-2 w-full py-3 bg-[#594a40] text-[#f8e8c1] rounded-xl text-sm font-bold shadow-sm active:scale-95 transition">
                                    <img src="https://a.amap.com/pc/static/favicon.ico" class="w-4 h-4 rounded-full"> 
                                    {{ t('navMap') }} (AMAP)
                                </a>
                            </div>
                        </div>

                        <!-- 行前準備 -->
                        <div v-if="activeModal === 'prep'" class="space-y-3">
                            <div class="text-sm opacity-60 text-center mb-2">{{ t('clickToCheck') }}</div>
                            <div v-for="(item, idx) in todoList" :key="idx" 
                                 class="flex items-center gap-4 p-4 bg-white/90 rounded-2xl shadow-sm cursor-pointer hover:bg-white transition active:scale-[0.99]"
                                 @click="toggleTodo(idx)">
                                <div class="w-6 h-6 rounded-md border-2 flex items-center justify-center transition-all duration-200 shrink-0"
                                     :class="item.checked ? 'bg-[#594a40] border-[#594a40]' : 'border-[#deaa6e] bg-white'">
                                    <i v-if="item.checked" class="fa-solid fa-check text-[#f8e8c1] text-xs"></i>
                                </div>
                                <span class="text-lg font-bold text-[#594a40]" :class="{'line-through opacity-40': item.checked}">
                                    {{ currentLang === 'zh' ? item.zh : item.kr }}
                                </span>
                            </div>
                            
                            <!-- 圖片參考 -->
                            <div class="mt-8 pt-6 border-t border-[#594a40]/10">
                                <h4 class="font-bold mb-3 flex items-center gap-2 text-[#594a40]">
                                    <i class="fa-solid fa-plug"></i> {{ currentLang === 'zh' ? '轉插 / 適配器' : '아뎁터 (Adapter)' }}
                                </h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="relative group overflow-hidden rounded-xl shadow-sm">
                                        <img src="https://dimg04.c-ctrip.com/images/0M75312000gmvwxar988F.jpg_.webp" class="w-full h-32 object-cover">
                                    </div>
                                    <div class="relative group overflow-hidden rounded-xl shadow-sm">
                                        <img src="https://dimg04.c-ctrip.com/images/0M73l12000gmvmheu5762.jpg_.webp" class="w-full h-32 object-cover">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 資訊地圖 -->
                        <div v-if="activeModal === 'info'" class="space-y-4">
                            <a href="https://ditu.yiwugo.com/" target="_blank" class="bg-white p-5 rounded-2xl shadow-sm flex items-center justify-between group active:scale-95 transition">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <i class="fa-solid fa-cart-shopping text-[#deaa6e]"></i>
                                        <h3 class="font-bold text-lg">{{ currentLang === 'zh' ? '義烏國際商貿地圖' : '이우 국제 상업 무역 지도' }}</h3>
                                    </div>
                                    <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">External Link</span>
                                </div>
                                <i class="fa-solid fa-arrow-up-right-from-square text-[#594a40] text-xl"></i>
                            </a>
                            <a href="https://www.hengdianworld.com/Uploads/202510051011u513z6.jpg" target="_blank" class="bg-white p-5 rounded-2xl shadow-sm flex items-center justify-between group active:scale-95 transition">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <i class="fa-solid fa-film text-[#deaa6e]"></i>
                                        <h3 class="font-bold text-lg">{{ currentLang === 'zh' ? '橫店影視城 明清宮苑' : '헝디엔 명청궁원 지도' }}</h3>
                                    </div>
                                    <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">Image Map</span>
                                </div>
                                <i class="fa-solid fa-image text-[#594a40] text-xl"></i>
                            </a>
                        </div>

                        <!-- 匯率計算 -->
                        <div v-if="activeModal === 'rate'" class="space-y-6">
                            <div class="bg-white p-6 rounded-3xl shadow-sm text-center">
                                <div class="text-xs font-bold text-[#deaa6e] tracking-[0.2em] mb-6">REALTIME EXCHANGE RATE</div>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="flex-1">
                                        <div class="bg-[#f8e8c1]/40 p-4 rounded-2xl border-2 border-transparent focus-within:border-[#deaa6e] transition">
                                            <label class="block text-xs font-bold mb-1 opacity-50">CNY (人民幣)</label>
                                            <input type="number" v-model="calcCny" @input="updateKrw" class="w-full bg-transparent text-center font-bold text-2xl outline-none text-[#594a40] placeholder-[#594a40]/20">
                                        </div>
                                    </div>
                                    <i class="fa-solid fa-arrow-right-arrow-left text-[#deaa6e] text-lg"></i>
                                    <div class="flex-1">
                                        <div class="bg-[#f8e8c1]/40 p-4 rounded-2xl border-2 border-transparent focus-within:border-[#deaa6e] transition">
                                            <label class="block text-xs font-bold mb-1 opacity-50">KRW (韓元)</label>
                                            <input type="number" v-model="calcKrw" @input="updateCny" class="w-full bg-transparent text-center font-bold text-2xl outline-none text-[#594a40] placeholder-[#594a40]/20">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-xs opacity-50 mb-6 bg-gray-100 inline-block px-3 py-1 rounded-full">1 CNY ≈ {{ exchangeRate }} KRW</div>
                                
                                <button @click="fetchRate" class="w-full py-4 rounded-xl bg-[#594a40] text-[#f8e8c1] font-bold text-sm shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-rotate"></i> 
                                    {{ currentLang === 'zh' ? '更新即時匯率' : '환율 업데이트 (Update)' }}
                                </button>
                                <div class="text-[9px] mt-2 opacity-40">Data source: ExchangeRate-API</div>
                            </div>
                        </div>

                    </div>
                </div>
            </transition>
        </div>
    </transition>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // 基本狀態
            const currentLang = ref('zh');
            const selectedDate = ref('2025-12-30'); // 預設第一天
            const scheduleDates = [
                '2025-12-30', '2025-12-31', '2026-01-01', 
                '2026-01-02', '2026-01-03', '2026-01-04'
            ];
            
            const activeModal = ref(null);
            const weather = ref(null);
            const itineraries = ref({});
            const exchangeRate = ref(190.5); // 預設匯率
            const calcCny = ref(100);
            const calcKrw = ref(19050);

            // 航班數據
            const flightData = {
                '2025-12-30': {
                    zh: [
                        { code: 'CX960', depTime: '12:05', arrTime: '14:30', depAirport: 'HKG', depTerminal: 'T1', arrAirport: 'HGH', arrTerminal: 'T4' },
                        { code: 'CZ3869', depTime: '12:10', arrTime: '14:10', depAirport: 'CAN', depTerminal: 'T2', arrAirport: 'HGH', arrTerminal: 'T4' }
                    ],
                    ko: [
                        // 韓文版去程顯示 OZ359，只有到達時間，這裡模擬起飛時間以符合UI結構
                        { code: 'OZ359', depTime: '11:45', arrTime: '13:45', depAirport: 'ICN', depTerminal: 'T1', arrAirport: 'HGH', arrTerminal: 'T4' }
                    ]
                },
                '2026-01-04': {
                    zh: [
                        { code: 'CX961', depTime: '15:45', arrTime: '18:30', depAirport: 'HGH', depTerminal: 'T4', arrAirport: 'HKG', arrTerminal: 'T1' },
                        { code: 'GJ8995', depTime: '19:05', arrTime: '21:15', depAirport: 'HGH', depTerminal: '-', arrAirport: 'CAN', arrTerminal: '-' }
                    ],
                    ko: [
                        // 韓文版回程顯示 OZ360
                        { code: 'OZ360', depTime: '15:05', arrTime: '18:10', depAirport: 'HGH', depTerminal: 'T4', arrAirport: 'ICN', arrTerminal: 'T1' }
                    ]
                }
            };

            // 酒店數據
            const hotels = {
                zh: [
                    { city: '義烏', name: '義烏雅悅酒店', address: '滙港路599-1號, 義烏', url: 'https://surl.amap.com/6XmTj5T12fs0' },
                    { city: '杭州', name: '杭州西湖武林Pagoda君亭設計酒店', address: '體育場路261號, 杭州', url: 'https://surl.amap.com/n94yQv1sdob' }
                ],
                ko: [
                    { city: 'Yiwu', name: 'Yiwu Yandoo Yayue Hotel', address: 'No.599-1 Huigang Road, 322000 Yiwu', url: 'https://surl.amap.com/6XmTj5T12fs0' },
                    { city: 'Hangzhou', name: 'Pagoda Hotel Hangzhou', address: 'No.261 Tiyuchang Road, Hangzhou', url: 'https://surl.amap.com/n94yQv1sdob' }
                ]
            };

            // 行前清單
            const todoList = ref([
                { zh: '香港身分證', kr: '홍콩 신분증', checked: false },
                { zh: '回鄉證 / 護照', kr: '여권 (Passport)', checked: false },
                { zh: '轉插 (Adapter)', kr: '아뎁터 (Adapter)', checked: false },
                { zh: '手機充電線', kr: '충전기', checked: false },
                { zh: '上網卡或漫遊', kr: '유심 / 포켓와이파이', checked: false },
                { zh: '衛生用品', kr: '개인 위생용품', checked: false },
                { zh: '保暖衣物', kr: '따뜻한 옷', checked: false },
                { zh: '救急藥物 (感冒/胃藥)', kr: '비상약', checked: false },
                { zh: '海外簽賬信用卡/支付寶', kr: '해외 결제 카드 / 알리페이', checked: false }
            ]);

            // 多語言文本
            const texts = {
                zh: { 
                    title: '義烏杭州之旅', 
                    schedule: '每日行程', 
                    noSchedule: '點擊 + 新增行程', 
                    flightInfo: '航班資訊', 
                    navMap: '高德地圖導航', 
                    clickToCheck: '點擊項目以標記完成',
                    menu: { hotel: '酒店', prep: '行前準備', info: '資訊', rate: '匯率' } 
                },
                ko: { 
                    title: '이우항주여행', 
                    schedule: '일일 일정', 
                    noSchedule: '+ 버튼을 눌러 일정 추가', 
                    flightInfo: '항공편 정보', 
                    navMap: '지도 보기 (Amap)', 
                    clickToCheck: '항목을 클릭하여 확인하세요',
                    menu: { hotel: '호텔', prep: '준비사항', info: '자료', rate: '환율' } 
                }
            };

            // 計算屬性
            const t = (k) => {
                const keys = k.split('.');
                let val = texts[currentLang.value];
                keys.forEach(sub => val = val[sub]);
                return val;
            };

            const currentLocationName = computed(() => {
                const yiwu = ['2025-12-30', '2025-12-31', '2026-01-01', '2026-01-02'];
                if(currentLang.value === 'zh') return yiwu.includes(selectedDate.value) ? '義烏' : '杭州';
                return yiwu.includes(selectedDate.value) ? '이우 (Yiwu)' : '항주 (Hangzhou)';
            });

            const currentFlights = computed(() => {
                const dateData = flightData[selectedDate.value];
                if (!dateData) return [];
                return dateData[currentLang.value] || [];
            });

            const isFlightDate = computed(() => !!currentFlights.value.length);
            
            const currentItinerary = computed(() => {
                if (!itineraries.value[selectedDate.value]) return [];
                return itineraries.value[selectedDate.value];
            });

            // 方法
            const formatDate = (ds) => {
                const d = new Date(ds);
                return `${d.getMonth()+1}/${d.getDate()}`;
            };
            
            const formatDateFull = (ds) => {
                const d = new Date(ds);
                return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
            }

            const toggleLang = () => currentLang.value = currentLang.value === 'zh' ? 'ko' : 'zh';

            // 行程 CRUD
            const addItem = () => {
                const time = prompt("Time (e.g. 09:00)", "09:00"); if(!time) return;
                const content = prompt("Activity", ""); if(!content) return;
                
                if (!itineraries.value[selectedDate.value]) itineraries.value[selectedDate.value] = [];
                itineraries.value[selectedDate.value].push({ id: Date.now(), time, content, isEditing: false });
                sortItinerary();
                saveToLocal();
            };
            const deleteItem = (idx) => { if(confirm('Delete this item?')) { itineraries.value[selectedDate.value].splice(idx, 1); saveToLocal(); }};
            const editItem = (idx) => { 
                const it = itineraries.value[selectedDate.value][idx]; 
                it.editTime = it.time; 
                it.editContent = it.content; 
                it.isEditing = true; 
            };
            const saveItem = (idx) => { 
                const it = itineraries.value[selectedDate.value][idx]; 
                it.time = it.editTime; 
                it.content = it.editContent; 
                it.isEditing = false; 
                sortItinerary();
                saveToLocal(); 
            };
            const cancelEdit = (idx) => itineraries.value[selectedDate.value][idx].isEditing = false;
            
            const sortItinerary = () => {
                itineraries.value[selectedDate.value].sort((a,b) => a.time.localeCompare(b.time));
            };

            const saveToLocal = () => {
                localStorage.setItem('trip_itinerary_2025', JSON.stringify(itineraries.value));
                localStorage.setItem('trip_todos_2025', JSON.stringify(todoList.value));
            };

            // Modal & Tools
            const openModal = (m) => { activeModal.value = m; if(m==='rate') fetchRate(); };
            const closeModal = () => activeModal.value = null;
            const toggleTodo = (i) => { todoList.value[i].checked = !todoList.value[i].checked; saveToLocal(); };
            
            const updateKrw = () => calcKrw.value = (calcCny.value * exchangeRate.value).toFixed(0);
            const updateCny = () => calcCny.value = (calcKrw.value / exchangeRate.value).toFixed(2);
            
            // API Calls
            const fetchRate = async () => {
                try {
                    const r = await fetch('https://api.exchangerate-api.com/v4/latest/CNY');
                    const d = await r.json();
                    if(d.rates.KRW) {
                        exchangeRate.value = d.rates.KRW;
                        updateKrw();
                    }
                } catch(e) { console.error("Rate API Error"); }
            };

            const fetchWeather = async () => {
                // 義烏座標: 29.31, 120.07 ; 杭州座標: 30.27, 120.15
                const yiwu = ['2025-12-30', '2025-12-31', '2026-01-01', '2026-01-02'];
                const isYiwu = yiwu.includes(selectedDate.value);
                const lat = isYiwu ? 29.31 : 30.27;
                const lon = isYiwu ? 120.07 : 120.15;
                
                try {
                    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const d = await r.json();
                    weather.value = d.current_weather;
                } catch(e) { console.error("Weather API Error"); }
            };

            // 初始化
            onMounted(() => {
                const saved = localStorage.getItem('trip_itinerary_2025');
                if(saved) itineraries.value = JSON.parse(saved);
                
                const savedTodos = localStorage.getItem('trip_todos_2025');
                if(savedTodos) todoList.value = JSON.parse(savedTodos);
                
                fetchWeather();
            });

            watch(selectedDate, fetchWeather);

            return {
                currentLang, selectedDate, scheduleDates, activeModal, weather,
                currentFlights, isFlightDate, currentItinerary, hotels, todoList,
                calcCny, calcKrw, exchangeRate, currentLocationName,
                t, formatDate, formatDateFull, toggleLang, addItem, deleteItem, editItem, saveItem, cancelEdit,
                openModal, closeModal, toggleTodo, updateKrw, updateCny, fetchRate
            };
        }
    }).mount('#app');
</script>
</body>
</html>